<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prijsdetails - TaxiToday.nl</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <a href="index.html" class="text-2xl font-bold text-blue-600 flex items-center">
                    <img src="TaxiToday_Logo_Blue.png" alt="TaxiToday" class="h-10 mr-2">
                </a>
                <span class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">NL</span>
            </div>
            
            <nav class="hidden md:flex space-x-8">
                <a href="index.html#pricing" class="nav-link font-medium hover:text-blue-600">Prijzen</a>
                <a href="index.html#service" class="nav-link font-medium hover:text-blue-600">Service</a>
                <a href="over-ons.html" class="nav-link font-medium hover:text-blue-600">Over ons</a>
                <a href="contact.html" class="nav-link font-medium hover:text-blue-600">Contact</a>
                <!-- Auth buttons - will be toggled by JavaScript based on auth status -->
                <a href="login.html" class="nav-link font-medium hover:text-blue-600 login-btn">Login</a>
                <a href="profile.html" class="nav-link font-medium text-blue-600 profile-btn hidden">
                    <i class="fas fa-user-circle mr-1"></i> Mijn Profiel
                </a>
                <button class="nav-link font-medium hover:text-red-600 logout-btn hidden">
                    <i class="fas fa-sign-out-alt mr-1"></i> Uitloggen
                </button>
            </nav>
            
            <div class="flex items-center space-x-4">
                <a href="tel:+31202613210" class="hidden md:flex items-center text-blue-600 font-medium">
                    <i class="fas fa-phone-alt mr-2"></i>
                    020 261 32 10
                </a>
                <button class="md:hidden text-gray-600" id="mobileMenuBtn">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-white py-2 px-4 shadow-lg">
            <a href="index.html#pricing" class="block py-2 hover:text-blue-600">Prijzen</a>
            <a href="index.html#service" class="block py-2 hover:text-blue-600">Service</a>
            <a href="over-ons.html" class="block py-2 hover:text-blue-600">Over ons</a>
            <a href="contact.html" class="block py-2 hover:text-blue-600">Contact</a>
            <!-- Auth links - will be toggled by JavaScript based on auth status -->
            <a href="login.html" class="block py-2 hover:text-blue-600 login-btn">Login</a>
            <a href="profile.html" class="block py-2 text-blue-600 profile-btn hidden">
                <i class="fas fa-user-circle mr-1"></i> Mijn Profiel
            </a>
            <button class="block py-2 hover:text-red-600 w-full text-left logout-btn hidden">
                <i class="fas fa-sign-out-alt mr-1"></i> Uitloggen
            </button>
            <a href="tel:+31202613210" class="block py-2 text-blue-600 font-medium">
                <i class="fas fa-phone-alt mr-2"></i>
                020 261 32 10
            </a>
        </div>
    </header>

    <!-- Price Details Section -->
    <section class="py-16 md:py-24">
        <div class="container mx-auto px-4">
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
                    <div class="text-center mb-8">
                        <div class="inline-block p-4 bg-blue-100 rounded-full text-blue-600 text-4xl mb-4">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold mb-2">Prijsberekening</h1>
                        <p class="text-gray-600">Hier zijn de details van uw taxirit</p>
                    </div>
                    
                    <div class="border-2 border-dashed border-gray-200 rounded-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Ritdetails</h2>
                            <span id="priceReference" class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full font-medium">PRIJS: CALC001</span>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-sm text-gray-600 mb-1">Ophaaladres</h3>
                                <p id="pickupAddress" class="font-medium">Centraal Station, Amsterdam</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm text-gray-600 mb-1">Bestemmingsadres</h3>
                                <p id="destinationAddress" class="font-medium">Schiphol Airport, Haarlemmermeer</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm text-gray-600 mb-1">Datum & Tijd</h3>
                                <p id="dateTime" class="font-medium">30-05-2024 om 14:30</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm text-gray-600 mb-1">Passagiers</h3>
                                <p id="passengers" class="font-medium">2 personen</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm text-gray-600 mb-1">Voertuigtype</h3>
                                <p id="vehicleType" class="font-medium">Standaard Taxi</p>
                            </div>
                            
                            <div>
                                <h3 class="text-sm text-gray-600 mb-1">Geschatte afstand</h3>
                                <p id="distance" class="font-medium">22.5 km</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Breakdown -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <h2 class="text-lg font-bold mb-4 text-blue-800">Prijsopbouw</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Instaptarief</span>
                                <span id="baseFare" class="font-medium">€2,95</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Rijtarief (<span id="distanceKm">22.5</span> km × €2,50)</span>
                                <span id="distanceFare" class="font-medium">€56,25</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">Servicekosten</span>
                                <span id="serviceFee" class="font-medium">€5,00</span>
                            </div>
                            <div class="border-t border-blue-200 pt-3 flex justify-between items-center">
                                <span class="text-gray-700">Subtotaal</span>
                                <span id="subtotal" class="font-medium">€64,20</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">BTW (9%)</span>
                                <span id="vat" class="font-medium">€5,78</span>
                            </div>
                            <div class="border-t-2 border-blue-300 pt-3 flex justify-between items-center font-bold text-lg">
                                <span class="text-blue-800">Totaalprijs (incl. BTW)</span>
                                <span id="totalPrice" class="text-blue-600 text-2xl">€65,25</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information Form -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
                        <h2 class="text-lg font-bold mb-4">Uw contactgegevens</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1">E-mailadres</label>
                                <input type="email" id="customerEmail" class="w-full py-2 px-3 border border-gray-300 rounded-lg" value="ramazan.barlas@gmail.com" readonly>
                            </div>
                            <div>
                                <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefoonnummer</label>
                                <input type="tel" id="customerPhone" class="w-full py-2 px-3 border border-gray-300 rounded-lg" value="0634190777" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                        <h2 class="text-lg font-bold mb-4 text-yellow-800">
                            <i class="fas fa-credit-card mr-2"></i>Betaling vereist
                        </h2>
                        <p class="text-yellow-700 mb-4">Om uw boeking te bevestigen, dient u eerst te betalen via onze beveiligde betalingsomgeving.</p>
                        
                        <!-- Payment Method Selection -->
                        <div class="mb-4">
                            <h3 class="font-medium mb-2">Kies uw betaalmethode:</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="payment-method-btn active" data-method="card">
                                    <i class="fas fa-credit-card text-xl mb-1"></i>
                                    <span class="text-sm">Creditcard</span>
                                </div>
                                <div class="payment-method-btn" data-method="ideal">
                                    <i class="fas fa-university text-xl mb-1"></i>
                                    <span class="text-sm">iDEAL</span>
                                </div>
                                <div class="payment-method-btn" data-method="paypal">
                                    <i class="fab fa-paypal text-xl mb-1"></i>
                                    <span class="text-sm">PayPal</span>
                                </div>
                                <div class="payment-method-btn" data-method="bancontact">
                                    <i class="fas fa-credit-card text-xl mb-1"></i>
                                    <span class="text-sm">Bancontact</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stripe Elements Container -->
                        <div id="payment-element" class="mb-4 p-4 border border-gray-300 rounded-lg bg-white hidden">
                            <!-- Stripe Elements will be inserted here -->
                        </div>

                        <!-- Payment Error Display -->
                        <div id="payment-errors" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <button id="payAndBookBtn" class="btn-primary w-full md:flex-1">
                            <i class="fas fa-lock mr-2"></i> Betaal & Bevestig Boeking
                        </button>
                        <button id="modifyBtn" class="btn-secondary w-full md:flex-1 bg-gray-600 hover:bg-gray-700 text-white">
                            <i class="fas fa-edit mr-2"></i> Wijzig Details
                        </button>
                        <a href="index.html" class="btn-secondary w-full md:flex-1 bg-red-600 hover:bg-red-700 text-white text-center">
                            <i class="fas fa-times mr-2"></i> Annuleren
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ElevenLabs Convai Agent -->
    <div class="fixed bottom-6 right-6 z-50">
        <elevenlabs-convai agent-id="agent_01jvfmapr8e6f8mn92sex8797s"></elevenlabs-convai>
        <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="md:flex md:justify-between">
                <div class="mb-6 md:mb-0">
                    <a href="index.html" class="text-2xl font-bold text-white flex items-center">
                        <img src="TaxiToday_Logo_white.png" alt="TaxiToday" class="h-10 mr-2">
                    </a>
                    <p class="mt-2 text-gray-400">Professionele taxiservice in heel Nederland.</p>
                </div>
                <div class="grid grid-cols-2 gap-8 sm:grid-cols-3">
                    <div>
                        <h3 class="font-bold mb-3">Links</h3>
                        <ul class="space-y-2">
                            <li><a href="index.html#booking" class="text-gray-400 hover:text-white">Boek een taxi</a></li>
                            <li><a href="index.html#pricing" class="text-gray-400 hover:text-white">Prijzen</a></li>
                            <li><a href="over-ons.html" class="text-gray-400 hover:text-white">Over ons</a></li>
                            <li><a href="contact.html" class="text-gray-400 hover:text-white">Contact</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold mb-3">Contact</h3>
                        <ul class="space-y-2">
                            <li class="text-gray-400">020 261 32 10</li>
                            <li class="text-gray-400">info@taxitoday.nl</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-700 md:flex md:justify-between">
                <p class="text-gray-400 text-sm">© 2024 TaxiToday. Alle rechten voorbehouden.</p>
                <div class="flex mt-4 md:mt-0 space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white">
                        <i class="fab fa-twitter"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Stripe configuration
        const stripe = Stripe('pk_test_your_publishable_key_here'); // Replace with your actual publishable key
        let elements;
        let paymentElement;
        let selectedPaymentMethod = 'card';

        document.addEventListener('DOMContentLoaded', function() {
            // Get booking data from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            
            // Load booking data from localStorage if available
            const bookingData = JSON.parse(localStorage.getItem('priceCalculation') || '{}');
            
            // Fill in the details if data is available
            if (bookingData.pickup) {
                document.getElementById('pickupAddress').textContent = bookingData.pickup;
            }
            if (bookingData.destination) {
                document.getElementById('destinationAddress').textContent = bookingData.destination;
            }
            if (bookingData.date && bookingData.time) {
                document.getElementById('dateTime').textContent = `${bookingData.date} om ${bookingData.time}`;
            }
            if (bookingData.passengers) {
                document.getElementById('passengers').textContent = bookingData.passengers + ' personen';
            }
            if (bookingData.vehicleType) {
                const vehicleTypes = {
                    'standard': 'Standaard Taxi',
                    'comfort': 'Comfort Taxi',
                    'van': 'Van Taxi'
                };
                document.getElementById('vehicleType').textContent = vehicleTypes[bookingData.vehicleType] || 'Standaard Taxi';
            }
            if (bookingData.email) {
                document.getElementById('customerEmail').value = bookingData.email;
            }
            if (bookingData.phone) {
                document.getElementById('customerPhone').value = bookingData.phone;
            }
            
            // Calculate and display price breakdown
            const distance = bookingData.distance || 22.5;
            const baseFare = 2.95;
            const pricePerKm = 2.50;
            const serviceFee = 5.00;
            
            const distanceFare = distance * pricePerKm;
            const subtotal = baseFare + distanceFare + serviceFee;
            const vat = subtotal * 0.09;
            const total = subtotal + vat;
            
            // Update display
            document.getElementById('distance').textContent = distance.toFixed(1) + ' km';
            document.getElementById('distanceKm').textContent = distance.toFixed(1);
            document.getElementById('baseFare').textContent = '€' + baseFare.toFixed(2);
            document.getElementById('distanceFare').textContent = '€' + distanceFare.toFixed(2);
            document.getElementById('serviceFee').textContent = '€' + serviceFee.toFixed(2);
            document.getElementById('subtotal').textContent = '€' + subtotal.toFixed(2);
            document.getElementById('vat').textContent = '€' + vat.toFixed(2);
            document.getElementById('totalPrice').textContent = '€' + total.toFixed(2);

            // Initialize Stripe Elements
            initializeStripeElements(total);

            // Payment method selection
            const paymentMethodBtns = document.querySelectorAll('.payment-method-btn');
            paymentMethodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    paymentMethodBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedPaymentMethod = this.getAttribute('data-method');
                    
                    // Show/hide payment element based on method
                    const paymentElementDiv = document.getElementById('payment-element');
                    if (selectedPaymentMethod === 'card') {
                        paymentElementDiv.classList.remove('hidden');
                    } else {
                        paymentElementDiv.classList.add('hidden');
                    }
                });
            });

            // Pay and book button functionality
            document.getElementById('payAndBookBtn').addEventListener('click', function() {
                handlePayment(total, bookingData);
            });
            
            // Modify button functionality
            document.getElementById('modifyBtn').addEventListener('click', function() {
                // Go back to booking form with current data
                window.location.href = 'index.html#booking';
            });
            
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });

        // Initialize Stripe Elements
        async function initializeStripeElements(amount) {
            try {
                // Create payment intent on your server
                const response = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: Math.round(amount * 100), // Convert to cents
                        currency: 'eur',
                        metadata: {
                            booking_type: 'taxi_ride',
                            customer_email: document.getElementById('customerEmail').value,
                            customer_phone: document.getElementById('customerPhone').value
                        }
                    }),
                });

                const { client_secret } = await response.json();

                // Initialize Elements
                elements = stripe.elements({
                    clientSecret: client_secret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#3b82f6',
                            colorBackground: '#ffffff',
                            colorText: '#374151',
                            colorDanger: '#ef4444',
                            fontFamily: 'Roboto, Arial, sans-serif',
                            spacingUnit: '4px',
                            borderRadius: '8px',
                        }
                    }
                });

                // Create and mount the Payment Element
                paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');

                // Show payment element by default for card payments
                document.getElementById('payment-element').classList.remove('hidden');

            } catch (error) {
                console.error('Error initializing Stripe:', error);
                showPaymentError('Er is een fout opgetreden bij het initialiseren van de betaling. Probeer het opnieuw.');
            }
        }

        // Handle payment submission
        async function handlePayment(amount, bookingData) {
            const payBtn = document.getElementById('payAndBookBtn');
            const originalText = payBtn.innerHTML;
            
            // Show loading state
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Betaling verwerken...';
            payBtn.disabled = true;

            try {
                if (selectedPaymentMethod === 'card') {
                    // Handle card payment with Stripe Elements
                    const { error, paymentIntent } = await stripe.confirmPayment({
                        elements,
                        confirmParams: {
                            return_url: window.location.origin + '/booking-confirmation.html',
                            payment_method_data: {
                                billing_details: {
                                    email: document.getElementById('customerEmail').value,
                                    phone: document.getElementById('customerPhone').value,
                                }
                            }
                        },
                        redirect: 'if_required'
                    });

                    if (error) {
                        showPaymentError(error.message);
                        payBtn.innerHTML = originalText;
                        payBtn.disabled = false;
                    } else if (paymentIntent.status === 'succeeded') {
                        // Payment successful, create booking
                        await createBookingAfterPayment(bookingData, paymentIntent.id);
                    }
                } else {
                    // Handle other payment methods (iDEAL, PayPal, etc.)
                    await handleAlternativePayment(selectedPaymentMethod, amount, bookingData);
                }
            } catch (error) {
                console.error('Payment error:', error);
                showPaymentError('Er is een fout opgetreden tijdens de betaling. Probeer het opnieuw.');
                payBtn.innerHTML = originalText;
                payBtn.disabled = false;
            }
        }

        // Handle alternative payment methods
        async function handleAlternativePayment(method, amount, bookingData) {
            try {
                const response = await fetch('/api/create-payment-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payment_method: method,
                        amount: Math.round(amount * 100),
                        currency: 'eur',
                        booking_data: bookingData,
                        success_url: window.location.origin + '/booking-confirmation.html',
                        cancel_url: window.location.href
                    }),
                });

                const { url } = await response.json();
                
                // Redirect to payment provider
                window.location.href = url;
            } catch (error) {
                console.error('Alternative payment error:', error);
                showPaymentError('Er is een fout opgetreden bij het verwerken van uw betaling.');
            }
        }

        // Create booking after successful payment
        async function createBookingAfterPayment(bookingData, paymentIntentId) {
            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        ...bookingData,
                        payment_intent_id: paymentIntentId,
                        payment_status: 'paid'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Store booking info for confirmation page
                    localStorage.setItem('lastBooking', JSON.stringify({
                        ...bookingData,
                        bookingId: result.bookingId,
                        paymentIntentId: paymentIntentId,
                        totalPrice: document.getElementById('totalPrice').textContent
                    }));
                    
                    // Redirect to confirmation page
                    window.location.href = 'booking-confirmation.html?ref=' + result.bookingId;
                } else {
                    showPaymentError('Betaling geslaagd, maar er is een fout opgetreden bij het maken van de boeking. Neem contact op met de klantenservice.');
                }
            } catch (error) {
                console.error('Booking creation error:', error);
                showPaymentError('Betaling geslaagd, maar er is een fout opgetreden bij het maken van de boeking. Neem contact op met de klantenservice.');
            }
        }

        // Show payment error
        function showPaymentError(message) {
            const errorDiv = document.getElementById('payment-errors');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Hide error after 10 seconds
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 10000);
        }
    </script>
    
    <script src="login.js"></script>

    <style>
        .payment-method-btn {
            @apply flex flex-col items-center justify-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 hover:border-blue-300 hover:bg-blue-50;
        }
        
        .payment-method-btn.active {
            @apply border-blue-500 bg-blue-50 text-blue-700;
        }
        
        .payment-method-btn i {
            @apply text-gray-600;
        }
        
        .payment-method-btn.active i {
            @apply text-blue-600;
        }
    </style>
</body>
</html>